<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Naboengs</title>
    <link rel="stylesheet" href="styles.css" />

    <!-- Ionicons CDN -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  </head>

  <body>
    <nav class="navbar">
      <div class="logo">
        <img src="img/logo transparent 512.png" alt="Logo" />
      </div>
    </nav>

    <section id="tabs">
      <button class="tab active">
        <ion-icon name="hourglass-outline"></ion-icon>
        Ditabung
      </button>
      <button class="tab">
        <ion-icon name="checkmark-outline"></ion-icon>
        Selesai
      </button>
    </section>

    <button id="add-button">
      <ion-icon name="add-outline"></ion-icon>
    </button>

    <section id="add-tab" class="tab form" style="display: none;">
      <div class="form-container">
        <label for="image-upload">Gambar</label>
        <input type="file" id="image-upload" accept="image/*" />

        <label for="nama">Nama</label>
        <input type="text" id="nama" placeholder="Masukkan Nama" />

        <label for="target">Target (Rp)</label>
        <input type="text" id="target" placeholder="Contoh: Rp 2.000.000" />

        <label for="perhari">Per Hari (Rp)</label>
        <input type="text" id="perhari" placeholder="Contoh: Rp 20.000" />
      </div>
      <button id="simpan-button">Simpan</button>
    </section>

    <script>
      // ðŸ”¥ Inisialisasi Firebase v8
      const firebaseConfig = {
        apiKey: "AIzaSyBoYdv7VKnxLcOassjGo-h8mPviTdPF5gE",
        authDomain: "naboengs.firebaseapp.com",
        databaseURL: "https://naboengs-default-rtdb.firebaseio.com/",
        projectId: "naboengs",
        storageBucket: "naboengs.appspot.com",
        messagingSenderId: "492503828776",
        appId: "1:492503828776:web:9c4c6cff4e820d7e69681d",
      };
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      const tabunganRef = database.ref("tabungan");

      // Toggle Form
      const addButton = document.getElementById("add-button");
      const addTab = document.querySelector(".tab.form");

      addButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const isShown = getComputedStyle(addTab).display !== "none";
        addTab.style.display = isShown ? "none" : "flex";

        if (!isShown) {
          addTab.scrollIntoView({ behavior: "smooth" });
        }
      });

      document.addEventListener("click", (e) => {
        const isClickInsideForm = addTab.contains(e.target);
        const isClickAddBtn = addButton.contains(e.target);
        if (!isClickInsideForm && !isClickAddBtn) {
          addTab.style.display = "none";
        }
      });

      // Format Rp
      function formatRupiah(angka) {
        let number_string = angka.replace(/[^,\d]/g, "").toString(),
          split = number_string.split(","),
          sisa = split[0].length % 3,
          rupiah = split[0].substr(0, sisa),
          ribuan = split[0].substr(sisa).match(/\d{3}/gi);

        if (ribuan) {
          let separator = sisa ? "." : "";
          rupiah += separator + ribuan.join(".");
        }

        rupiah = split[1] !== undefined ? rupiah + "," + split[1] : rupiah;
        return "Rp " + rupiah;
      }

      function setupRupiahInput(id) {
        const input = document.getElementById(id);
        input.addEventListener("input", function (e) {
          const value = e.target.value;
          e.target.value = formatRupiah(value);
        });
      }

      setupRupiahInput("target");
      setupRupiahInput("perhari");

      function parseRupiah(str) {
        return str.replace(/[^\d]/g, "");
      }

      function getImageBase64(file, callback) {
        const reader = new FileReader();
        reader.onloadend = () => callback(reader.result);
        reader.readAsDataURL(file);
      }

      // Simpan ke Firebase
      document.getElementById("simpan-button").addEventListener("click", () => {
        const nama = document.getElementById("nama").value.trim();
        const target = parseRupiah(document.getElementById("target").value);
        const perhari = parseRupiah(document.getElementById("perhari").value);
        const file = document.getElementById("image-upload").files[0];

        if (!nama || !target || !perhari || !file) {
          alert("Lengkapi semua data dulu ya!");
          return;
        }

        getImageBase64(file, (base64Image) => {
          tabunganRef.push({
            nama,
            target,
            perhari,
            gambar: base64Image,
          }).then(() => {
            alert("Data berhasil disimpan!");
            document.getElementById("nama").value = "";
            document.getElementById("target").value = "";
            document.getElementById("perhari").value = "";
            document.getElementById("image-upload").value = "";
            addTab.style.display = "none";
          });
        });
      });
    </script>
  </body>
</html>
