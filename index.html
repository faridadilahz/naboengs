<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Naboengs</title>
    <link rel="stylesheet" href="styles.css" />

    <!-- Ionicons -->
    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    ></script>

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  </head>

  <body>
    <div id="loader-overlay">
      <img
        src="img/logo transparent 512.png"
        alt="Logo Naboengs"
        class="loader-logo"
      />
    </div>

    <nav class="navbar">
      <div class="logo">
        <img src="img/logo transparent 512.png" alt="Logo" />
      </div>
    </nav>

    <section id="tabs">
      <button class="tab active">
        <ion-icon name="hourglass-outline"></ion-icon>
        Ditabung
      </button>
      <button class="tab">
        <ion-icon name="checkmark-outline"></ion-icon>
        Selesai
      </button>
    </section>

    <button id="add-button">
      <ion-icon name="add-outline"></ion-icon>
    </button>

    <section id="add-tab" class="tab form popup">
      <div class="popup-content">
        <div class="form-container">
          <label for="image-upload">Gambar</label>
          <input type="file" id="image-upload" accept="image/*" />

          <label for="nama">Nama Barang</label>
          <input type="text" id="nama" placeholder="Masukkan Nama" />

          <label for="target">Target</label>
          <input type="text" id="target" placeholder="Masukkan Target" />

          <label for="perhari">Perhari</label>
          <input
            type="text"
            id="perhari"
            placeholder="Masukkan Nominal Perhari"
          />
        </div>
        <div class="simpan-container">
          <button id="simpan-button">Simpan</button>
        </div>
      </div>
    </section>

    <section id="data-list" class="tabungan-list">
      <!-- Data akan tampil di sini -->
    </section>

    <script>
      // ✅ Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyBoYdv7VKnxLcOassjGo-h8mPviTdPF5gE",
        authDomain: "naboengs.firebaseapp.com",
        databaseURL: "https://naboengs-default-rtdb.firebaseio.com/",
        projectId: "naboengs",
        storageBucket: "naboengs.appspot.com",
        messagingSenderId: "492503828776",
        appId: "1:492503828776:web:9c4c6cff4e820d7e69681d",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      let uid = null;

      // ✅ Login anonim
      firebase
        .auth()
        .signInAnonymously()
        .catch((err) => {
          alert("Login gagal: " + err.message);
        });

      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          uid = user.uid;
          loadData(uid);
        }
      });

      // ✅ Toggle form
      // ✅ Toggle form
      const addBtn = document.getElementById("add-button");
      const addTab = document.getElementById("add-tab");

      addBtn.addEventListener("click", (e) => {
        e.preventDefault();
        addTab.style.display = "flex";
        document.body.style.overflow = "hidden";
        history.pushState({ popup: true }, "", "#popup");
      });

      window.addEventListener("popstate", (event) => {
        if (event.state && event.state.popup) {
          closePopup();
        }
      });

      function closePopup() {
        addTab.style.display = "none";
        document.body.style.overflow = "";

        // Kalau masih di URL #popup, hapus manual lewat replaceState
        if (location.hash === "#popup") {
          history.replaceState(null, "", location.pathname);
        }
      }

      document.addEventListener("click", function (e) {
        const isClickInside = addTab.contains(e.target);
        const isAddBtn = addBtn.contains(e.target);

        if (!isClickInside && !isAddBtn && addTab.style.display === "flex") {
          closePopup();
        }
      });

      // ✅ Format input
      function formatRupiah(angka) {
        let number_string = angka.replace(/[^,\d]/g, "").toString();
        let split = number_string.split(",");
        let sisa = split[0].length % 3;
        let rupiah = split[0].substr(0, sisa);
        let ribuan = split[0].substr(sisa).match(/\d{3}/gi);
        if (ribuan) {
          let separator = sisa ? "." : "";
          rupiah += separator + ribuan.join(".");
        }
        return "Rp " + rupiah + (split[1] ? "," + split[1] : "");
      }

      function setupRupiahInput(id) {
        const input = document.getElementById(id);
        input.addEventListener("input", (e) => {
          e.target.value = formatRupiah(e.target.value);
        });
      }

      setupRupiahInput("target");
      setupRupiahInput("perhari");

      function parseRupiah(str) {
        return str.replace(/[^\d]/g, "");
      }

      function getImageBase64(file, callback) {
        const reader = new FileReader();
        reader.onloadend = () => callback(reader.result);
        reader.readAsDataURL(file);
      }

      // ✅ Tampilkan data ke halaman
      function tampilkanData(data) {
        const list = document.getElementById("data-list");
        const item = document.createElement("div");
        item.className = "tabungan-item";

        const target = Number(data.target);
        const perhari = Number(data.perhari);
        const estimasiHari = perhari > 0 ? Math.ceil(target / perhari) : "-";

        item.innerHTML = `
    <img src="${data.gambar}" alt="${data.nama}" />
    <div class="tabungan-info">
      <strong style="font-size:26px;">${data.nama}</strong>
      <span style="font-size:20px;">Rp${target.toLocaleString("id-ID")}</span>
      <span style="font-size:20px;">Rp${perhari.toLocaleString(
        "id-ID"
      )}/ hari</span>
      <div class="estimasi-container">
      <span style="color: #888888; font-size: 16px;">${estimasiHari} hari lagi</span>
      </div>
    </div>
  `;

        list.appendChild(item);
      }

      // ✅ Simpan data
      document.getElementById("simpan-button").addEventListener("click", () => {
        const nama = document.getElementById("nama").value.trim();
        const target = parseRupiah(document.getElementById("target").value);
        const perhari = parseRupiah(document.getElementById("perhari").value);
        const file = document.getElementById("image-upload").files[0];

        if (!uid) return alert("Belum login, refresh halaman.");
        if (!nama || !target || !perhari || !file)
          return alert("Lengkapi semua data dulu ya!");

        getImageBase64(file, (base64) => {
          const data = { nama, target, perhari, gambar: base64 };
          db.ref("tabungan/" + uid)
            .push(data)
            .then(() => {
              alert("Tersimpan!");
              document.getElementById("nama").value = "";
              document.getElementById("target").value = "";
              document.getElementById("perhari").value = "";
              document.getElementById("image-upload").value = "";
              addTab.style.display = "none";
              tampilkanData(data);
            });
        });
      });

      // ✅ Ambil semua data dari UID
      function loadData(uid) {
        const userRef = db.ref("tabungan/" + uid);
        userRef.once("value", (snapshot) => {
          document.getElementById("data-list").innerHTML = "";
          snapshot.forEach((child) => {
            tampilkanData(child.val());
          });
        });
      }
      setTimeout(() => {
        const loader = document.getElementById("loader-overlay");
        loader.style.opacity = 0;
        loader.style.display = "none";
      }, 3000);
    </script>
  </body>
</html>
