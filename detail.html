<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Tabungan</title>
    <link rel="stylesheet" href="detail sytle/detail.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    ></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  </head>
  <body>
    <nav class="navbar">
      <button onclick="history.back()" class="back-btn">
        <ion-icon name="chevron-back-outline"></ion-icon>
      </button>
      <div id="tools-button" class="tools-container">
        <div class="edit-button">
          <ion-icon name="pencil-outline"></ion-icon>
          <span>Edit</span>
        </div>
        <div class="delete-button">
          <ion-icon name="trash-outline"></ion-icon>
          <span>Hapus</span>
        </div>
      </div>
    </nav>

    <main id="detail-container">
      <img id="gambar-detail" />
      <h2 id="nama-detail"></h2>
      <p id="target-detail"></p>
      <p id="perhari-detail"></p>
      <div id="tabel-info" class="flex-row">
        <div class="info-box">
          <p class="label">Terkumpul:</p>
          <p id="terkumpul-text" class="value">-</p>
        </div>
        <div class="info-box">
          <p class="label">Kekurangan:</p>
          <p id="kekurangan-text" class="value">-</p>
        </div>
      </div>

      <button class="floating-button" id="open-transaksi">
        <ion-icon name="create-outline"></ion-icon>
      </button>
    </main>

    <section id="popup-transaksi" class="popup">
      <div class="popup-content">
        <h3>Catatan Tabungan</h3>
        <div class="radio-group" id="jenis">
          <label class="radio-option">
            <input type="radio" name="jenis" value="tambah" checked />
            <span>Tambah</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="jenis" value="kurang" />
            <span>Kurang</span>
          </label>
        </div>
        <label for="jumlah">Jumlah</label>
        <input type="text" id="jumlah" placeholder="Masukkan nominal" />
        <label for="keterangan">Keterangan</label>
        <input type="text" id="keterangan" placeholder="Masukkan Keterangan" />
        <div class="simpan-container">
          <button id="simpan-transaksi">Simpan</button>
          <button id="batal-transaksi">Batal</button>
        </div>
      </div>
    </section>

    <section id="riwayat-container">
      <h3>Riwayat</h3>
      <ul id="riwayat-list"></ul>
    </section>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBoYdv7VKnxLcOassjGo-h8mPviTdPF5gE",
        authDomain: "naboengs.firebaseapp.com",
        databaseURL: "https://naboengs-default-rtdb.firebaseio.com/",
        projectId: "naboengs",
        storageBucket: "naboengs.appspot.com",
        messagingSenderId: "492503828776",
        appId: "1:492503828776:web:9c4c6cff4e820d7e69681d",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      let uid = null;
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get("id");

      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          uid = user.uid;
          loadDetail();
          loadRiwayat();
        } else {
          firebase
            .auth()
            .signInAnonymously()
            .then((result) => {
              uid = result.user.uid;
              loadDetail();
              loadRiwayat();
            })
            .catch((err) => {
              alert("Gagal login: " + err.message);
            });
        }
      });

      function loadDetail() {
        db.ref(`tabungan/${uid}/${id}`).on("value", (snapshot) => {
          const data = snapshot.val();
          if (!data) return;
          document.getElementById("gambar-detail").src = data.gambar;
          document.getElementById("nama-detail").textContent = data.nama;
          document.getElementById("target-detail").textContent =
            "Rp" + Number(data.target).toLocaleString("id-ID");
          document.getElementById("perhari-detail").textContent =
            "Rp" + Number(data.perhari).toLocaleString("id-ID") + "/hari";
        });
      }

      // Fungsi tombol hapus
      const deleteBtn = document.querySelector(".delete-button");

      deleteBtn.addEventListener("click", () => {
        const konfirmasi = confirm("Yakin ingin menghapus tabungan ini?");
        if (konfirmasi) {
          db.ref(`tabungan/${uid}/${id}`)
            .remove()
            .then(() => {
              alert("Tabungan berhasil dihapus.");
              window.location.href = "index.html";
            })
            .then(() => {
              return db.ref(`riwayat/${uid}/${id}`).remove();
            })

            .catch((err) => {
              alert("Gagal menghapus: " + err.message);
            });
        }
      });

      // Popup transaksi
      const popup = document.getElementById("popup-transaksi");
      const openBtn = document.getElementById("open-transaksi");
      const simpanBtn = document.getElementById("simpan-transaksi");
      const batalBtn = document.getElementById("batal-transaksi");

      openBtn.onclick = () => {
        popup.classList.add("show");
        setupRupiahInput("jumlah");
      };

      batalBtn.onclick = () => {
        popup.classList.remove("show");
        document.getElementById("jumlah").value = "";
        document.getElementById("keterangan").value = "";
      };

      simpanBtn.onclick = () => {
        const jenis = document.querySelector(
          'input[name="jenis"]:checked'
        ).value;
        const jumlah = parseInt(
          parseRupiah(document.getElementById("jumlah").value)
        );
        const keterangan = document.getElementById("keterangan").value.trim();
        if (!jumlah || !keterangan) return alert("Lengkapi dulu ya");

        const waktu = new Date().toLocaleString("id-ID");
        const riwayat = { jenis, jumlah, keterangan, waktu };

        db.ref(`riwayat/${uid}/${id}`)
          .push(riwayat)
          .then(() => {
            alert("Tersimpan!");
            document.getElementById("jumlah").value = "";
            document.getElementById("keterangan").value = "";
            popup.classList.remove("show");
            loadRiwayat();
          });
      };

      function loadRiwayat() {
        const list = document.getElementById("riwayat-list");
        list.innerHTML = "";
        const riwayatRef = db.ref(`riwayat/${uid}/${id}`);
        riwayatRef.on("value", (snapshot) => {
          list.innerHTML = "";
          snapshot.forEach((child) => {
            const r = child.val();
            const li = document.createElement("li");
            li.innerHTML = `
              <div class="riwayat-item ${r.jenis}">
                <div class="riwayat-top">
                  <span class="nominal">${
                    r.jenis === "tambah" ? "+" : "-"
                  }Rp${r.jumlah.toLocaleString("id-ID")}</span>
                  <span class="waktu">${r.waktu}</span>
                </div>
                <div class="keterangan">${r.keterangan}</div>
              </div>
            `;
            list.prepend(li);
          });

          // Panggil update total setelah memuat riwayat
          updateTerkumpulDanKekurangan();
        });
      }

      function updateTerkumpulDanKekurangan() {
        const riwayatRef = db.ref(`riwayat/${uid}/${id}`);
        const tabunganRef = db.ref(`tabungan/${uid}/${id}`);

        riwayatRef.once("value", (riwayatSnapshot) => {
          let totalTerkumpul = 0;

          riwayatSnapshot.forEach((child) => {
            const r = child.val();
            if (r.jenis === "tambah") totalTerkumpul += r.jumlah;
            if (r.jenis === "kurang") totalTerkumpul -= r.jumlah;
          });

          tabunganRef.once("value", (tabunganSnapshot) => {
            const tabungan = tabunganSnapshot.val();
            const target = parseInt(tabungan.target);
            const kekurangan = target - totalTerkumpul;

            document.getElementById("terkumpul-text").textContent =
              "Rp" + totalTerkumpul.toLocaleString("id-ID");
            document.getElementById("kekurangan-text").textContent =
              "" +
              (kekurangan <= 0
                ? "Selesai ðŸŽ‰"
                : "Rp" + kekurangan.toLocaleString("id-ID"));
          });
        });
      }

      function formatRupiah(angka) {
        let number_string = angka.replace(/[^,\d]/g, "").toString();
        let split = number_string.split(",");
        let sisa = split[0].length % 3;
        let rupiah = split[0].substr(0, sisa);
        let ribuan = split[0].substr(sisa).match(/\d{3}/gi);
        if (ribuan) {
          let separator = sisa ? "." : "";
          rupiah += separator + ribuan.join(".");
        }
        return "Rp " + rupiah + (split[1] ? "," + split[1] : "");
      }
      function setupRupiahInput(id) {
        const input = document.getElementById(id);
        input.addEventListener("input", (e) => {
          e.target.value = formatRupiah(e.target.value);
        });
      }

      setupRupiahInput("jumlah");

      function parseRupiah(str) {
        return str.replace(/[^\d]/g, "");
      }
    </script>
  </body>
</html>
